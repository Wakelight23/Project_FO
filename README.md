<!-- # ProjectFO_sign

# 개발 기간

- 24/12/2~24/12/9 (7일)

# 코드 구조

서버 설정 (app.js)

- Express 애플리케이션을 생성
- 환경 변수를 로드하여 서버를 설정
- 다양한 API 라우터를 /api 경로에 연결하여 회원가입, 로그인, 캐릭터, 삭제, 검색, 아이템 관련 기능 제공
- 지정된 포트(3002)에서 서버를 실행합니다.

Prisma 스키마
Accounts, RefreshToken, Manager , Player, TeamMember, Item, Inventory, Ranking, Record 모델 정의
그중 Accounts, RefreshToken, Manager 테이블을 위주로 개인 작업
Accounts
회원가입 중 수집하는 정보, 어드민 계정 판단, 매니저 모델과의 연계 설정
RefreshToken
로그인 성공 시 생성되는 리프레시 토큰 정보, 연계된 accountId
manager
계정 당 1개만 생성 가능한 매니저 닉네임, 보유캐쉬, 레이팅 등등

API

- 회원가입, 로그인, 매니저 생성, 전체 조회 API
- 인증 미들웨어
- 각각의 기능에 맞는 라우터로 구현
- app.js에서 /api 경로에 연결

인증 미들웨어 (authM.js)

//1. 엑세스 토큰이 유효할 때

> > jwt.verify를 통해 엑세스 토큰의 유효성 검사
> > 유효한 경우 accountid를 조건으로, prisma.findFirst()를 통해 사용자 정보 조회
> > 계정정보를 req.account에 저장하여 이후 API에서 사용할 수 있다

//2. 엑세스 토큰이 만료되었을 때

> > 만료된 토큰이 아닌 이메일 정보 헤더의 이메일을 통해 accountid 도출
> > 도출한 accountid로 리프레시 토큰 확인

//2-1. 리프레시 토큰 유효

> > 검증 후 새로운 엑세스 토큰 생성
> > 계정정보를 req.account에 저장하여 이후 API에서 사용하고,
> > 클라이언트 로컬저장소에 새로운 엑세스 토큰을 전달한다.
> > (사용자 입장에서는 로그인 없이 요청-전달 과정이 진행된다)

//2-2. 리프레시 토큰 만료

> > 사용자가 다시 로그인하여 리프레시 토큰을 새로 생성해야한다.

# 개발 환경

IDE: Visual Studio Code (VSCode)
서버: Amazon EC2 인스턴스
데이터베이스: mySQL 개인 서버
API 테스트 도구: Insomnia
버전 관리: GitHub

# 사용 라이브러리

@prisma/client: 데이터베이스와의 상호작용을 위한 Prisma 클라이언트
bcrypt: 비밀번호 해싱을 위한 라이브러리
dotenv: 환경 변수를 관리하기 위한 라이브러리
express: 웹 서버 프레임워크
jsonwebtoken: JWT 토큰 생성을 위한 라이브러리
prisma: Prisma ORM
nodemon: 개발 중 자동으로 서버를 재시작하기 위한 도구

# 핵심기능

사용자 회원가입 및 로그인
로그인 시 발행되는 토큰을 통해 인증 및 인가 진행
db에 저장된 리프레시 토큰을 통한 엑세스 토큰 재발행
사용자 개인 계정에 귀속되는 매니저 생성, 조회기능 -->

## 인증 시스템 (유대원)

- 로그인 성공 시 생성되는 엑세스 토큰은 사용자의 로컬스토리지에, 리프레시 토큰은 db에 저장합니다.

### 핵심기능

사용자 회원가입 및 로그인
로그인 시 발행되는 토큰을 통해 인증 및 인가 진행
db에 저장된 리프레시 토큰을 통한 엑세스 토큰 재발행
사용자 개인 계정에 귀속되는 매니저 생성, 조회기능

### 인증 미들웨어 (authM.js)

1. 엑세스 토큰이 유효할 때

> jwt.verify를 통해 엑세스 토큰의 유효성을 검사합니다.
> 유효한 경우 accountid를 조건으로, prisma.findFirst()를 통해 사용자 정보를 조회합니다.
> 계정정보를 req.account에 저장하여 이후 API에서 사용할 수 있습니다.

2. 엑세스 토큰이 만료되었을 때

> 만료된 토큰이 아닌 이메일 정보 헤더의 이메일을 통해 accountid를 도출합니다.
> 도출한 accountid로 db의 리프레시 토큰을 검증합니다.

- 리프레시 토큰이 유효한 경우

> 검증 후 새로운 엑세스 토큰을 생성합니다
> 계정정보를 req.account에 저장하여 이후 API에서 사용하고, 클라이언트 로컬저장소에 새로운 엑세스 토큰을 전달합니다.
> 사용자 입장에서는 로그인 없이 요청-전달 과정이 진행됩니다.

- 리프레시 토큰이 만료된 경우

> 사용자가 다시 로그인하여 리프레시 토큰을 새로 생성해야합니다.

### 회원가입, 로그인 API

회원가입 요청 시 서버로 전달된 정보에 대한 유효성을 검증하여 상태에 맞는 메시지를 클라이언트에 전달합니다. (이메일(id) 형식, 비밀번호 길이 등등)
검증 완료 시 db에 accountid를 순서대로 할당하여 저장합니다.

로그인 요청 시 서버로 전달된 이메일, 비밀번호를 통해 db의 정보와 비교합니다.
로그인에 성공하면 엑세스토큰을 클라이언트에 전달하고, 리프레시 토큰을 db에 저장합니다.

### 매니저 생성 API

매니저 생성 요청 시 서버로 전달된 닉네임의 중복 여부를 검증하고 인증 미들웨어에서 인증을 성공하여 전달받은 req.account에서 계정정보를 가져옵니다.
계정정보를 통해 매니저의 존재 유무를 확인하고, 없다면 입력한 닉네임, 기본 캐쉬, 기본 레이팅을 적용한 매니저를 생성합니다.(매니저는 계정당 1개만 생성할 수 있습니다)

### 랭킹 조회 API

db에 존재하는 모든 매니저를 레이팅 내림차순으로 정렬합니다.
